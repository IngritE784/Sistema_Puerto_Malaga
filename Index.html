<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gesti칩n - Tienda</title>

  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ---------- Variables y Configuraci칩n Global ---------- */
    :root {
      --primary: #0B2E59;
      --secondary: #E5533D;
      --light: #F4F6F8;
      --accent: #CFE6FA;
      --text-dark: #2C3E50;
      --text-light: #7F8C8D;
      --success: #27AE60;
      --warning: #F39C12;
      --danger: #E74C3C;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* ---------- Estilos del Layout Principal (Header y Sidebar) ---------- */
    .holy-grail {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-icon {
      font-size: 2rem;
      color: var(--secondary);
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .main-content {
      display: flex;
      flex: 1;
    }

    .sidebar {
      width: 250px;
      background: white;
      padding: 1.5rem 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .nav-menu {
      list-style: none;
    }

    .nav-item {
      padding: 0.8rem 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .nav-item:hover {
      background: var(--accent);
      border-right: 4px solid var(--secondary);
    }

    .nav-item.active {
      background: var(--accent);
      border-right: 4px solid var(--primary);
      font-weight: bold;
    }

    .content {
      flex: 1;
      padding: 2rem;
      background: var(--light);
    }

    .footer {
      background: var(--primary);
      color: white;
      text-align: center;
      padding: 1rem;
      margin-top: auto;
    }

    /* ---------- Componentes: Tarjetas y Gr치ficos ---------- */
    .card {
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--accent);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
    }

    /* Stats / KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .kpi-card {
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      gap: .9rem;
      border: 1px solid #eef2f5;
    }

    .kpi-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: var(--accent);
    }

    .kpi-title {
      font-size: .9rem;
      color: var(--text-light);
    }

    .kpi-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
    }

    .cards-graphics {
      display: grid;
      grid-template-columns: 2fr 3fr 2fr;
      gap: 1rem;
    }

    @media (max-width: 1100px) {
      .cards-graphics {
        grid-template-columns: 1fr;
      }
    }

    .chart-card {
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      border: 1px solid #eef2f5;
    }

    /* ---------- Estilos de Tablas ---------- */
    .tables-grid {
      display: grid;
      grid-template-columns: 2fr 2fr 3fr;
      gap: 1rem;
    }

    @media (max-width: 1100px) {
      .tables-grid {
        grid-template-columns: 1fr;
      }
    }

    .table-title {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: .5rem;
    }

    .table-sm {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      border: 1px solid #eef2f5;
      max-height: 260px;
      display: block;
      overflow-y: auto;
    }

    .table-sm table {
      width: 100%;
      border-collapse: collapse;
    }

    .table-sm th, .table-sm td {
      padding: .6rem .8rem;
      border-bottom: 1px solid #eef2f5;
      font-size: .92rem;
    }

    .table-sm th {
      background: #f6f9fc;
      color: #394a6a;
      text-transform: uppercase;
      letter-spacing: .02em;
      font-size: .78rem;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* ---------- Elementos de UI (Badges, Filtros, Botones) ---------- */
    .badge {
      display: inline-block;
      padding: .2rem .5rem;
      border-radius: 999px;
      font-size: .75rem;
      background: #eef4ff;
      color: #1e3a8a;
    }

    .badge-danger {
      background: #ffe4e6;
      color: #991b1b;
    }

    .filters-panel {
      display: grid;
      grid-template-columns: repeat(5, minmax(150px, 1fr)) auto;
      gap: .6rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 1100px) {
      .filters-panel {
        grid-template-columns: 1fr 1fr;
      }
    }

    .form-group { margin-bottom: 1rem; }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-dark);
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #E0E0E0;
      border-radius: 5px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background:#0A2550; }

    .btn-success { background: var(--success); color:white; }
    .btn-danger  { background: var(--danger);  color:white; }
    .btn-warning { background: var(--warning); color:white; }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .btn-ghost {
      background: #fff;
      border: 1px solid #e5e7eb;
    }

    /* ---------- Estilos de la Pantalla de Login ---------- */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, #1A4B8C 100%);
    }

    .login-card {
      background: white;
      padding: 3rem;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-title {
      color: var(--primary);
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.5rem;
    }

    /* Utilidades */
    .hidden { display:none !important; }
    .text-center { text-align:center; }
    .text-success { color:var(--success); }
    .text-warning { color:var(--warning); }
    .text-danger { color:var(--danger); }
    .mt-3 { margin-top:1rem; }
    .mb-3 { margin-bottom:1rem; }

    /* ---------- Estilos para Ventas y Productos ---------- */
    .productos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .producto-venta {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid var(--primary);
      transition: transform .2s;
    }

    .producto-venta:hover {
      transform: translateY(-3px);
    }

    .producto-venta.stock-bajo {
      border-left-color: var(--danger);
    }

    .cart-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem;
      border-bottom:1px solid #E0E0E0;
    }

    .cart-total {
      font-size:1.2rem;
      font-weight:bold;
      text-align:right;
      padding:1rem;
      border-top:2px solid var(--primary);
    }

    /* ---------- Estilos para Modales ---------- */
    .modal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }

    .modal-content {
      width:min(900px,95vw);
    }

    .modal-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .table-modal-wrapper {
      max-height: 70vh;
      overflow-y: auto;
    }

    /* ---------- Estilos para C치mara y Esc치ner (Quagga) ---------- */
    #videoCamara {
      width:100%;
      height:300px;
      background:#000;
      border-radius:8px;
      object-fit:cover;
    }

    .quagga-overlay {
      position:absolute;
      inset:0;
      border:3px solid #E5533D;
      border-radius:8px;
      pointer-events:none;
    }

    .scan-line {
      position:absolute;
      height:3px;
      background:#E5533D;
      width:100%;
      top:50%;
      animation:scan 2s ease-in-out infinite;
      box-shadow:0 0 10px #E5533D;
    }

    .scanning-indicator {
      position:absolute;
      top:10px;
      left:10px;
      background:rgba(229,83,61,0.9);
      color:white;
      padding:5px 10px;
      border-radius:5px;
      font-size:0.8rem;
      font-weight:bold;
    }

    @keyframes scan {
      0% { transform: translateY(-100px); }
      50%{ transform: translateY(100px); }
      100%{transform: translateY(-100px);}
    }

    /* ---------- Men칰s Desplegables (Dropdowns) ---------- */
    .dropdown {
      position: relative;
    }

    .dropdown-toggle {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 110%;
      min-width: 190px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(15,23,42,.15);
      border: 1px solid #e5e7eb;
      padding: .35rem 0;
      z-index: 1200;
      display: none;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      width: 100%;
      text-align: left;
      padding: .45rem 1rem;
      background: transparent;
      border: none;
      font-size: .9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .dropdown-item:hover {
      background: #f3f4f6;
    }
  </style>
</head>

<body>
  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <div class="login-logo">
        <i class="fas fa-store logo-icon" style="font-size: 3rem; color: var(--primary);"></i>
        <h1 style="color: var(--primary); margin-top: 1rem;">Multiservicios Sr. Puerto Malaga</h1>
      </div>
      <h2 class="login-title">Iniciar Sesi칩n</h2>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="loginEmail" required value="admin@tienda.com">
        </div>
        <div class="form-group">
          <label class="form-label">Contrase침a</label>
          <input type="password" class="form-control" id="loginPassword" required value="admin123">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">
          <i class="fas fa-sign-in-alt"></i> Ingresar
        </button>
      </form>
      <div class="mt-3" style="font-size: 0.8rem; color: var(--text-light); text-align: center;">
        <strong>Credenciales de prueba:</strong><br>
        Email: admin@tienda.com<br>
        Contrase침a: admin123
      </div>
    </div>
  </div>

  <div id="appScreen" class="holy-grail hidden">
    <header class="header">
      <div class="nav-bar">
        <div class="logo">
          <i class="fas fa-store logo-icon"></i>
          <span class="logo-text">Multiservicios Sr. Puerto Malaga</span>
        </div>
        <div class="user-info">
          <span id="userName">Usuario</span>
          <button class="btn btn-danger" id="btnLogout">
            <i class="fas fa-sign-out-alt"></i> Salir
          </button>
        </div>
      </div>
    </header>

    <div class="main-content">
      <nav class="sidebar">
        <ul class="nav-menu">
          <li class="nav-item active" onclick="showSection('dashboard', this)">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </li>
          <li class="nav-item" onclick="showSection('ventas', this)">
            <i class="fas fa-cash-register"></i>
            <span>Punto de Venta</span>
          </li>
          <li class="nav-item" onclick="showSection('productos', this)">
            <i class="fas fa-boxes"></i>
            <span>Productos</span>
          </li>
          <li class="nav-item" onclick="showSection('inventario', this)">
            <i class="fas fa-warehouse"></i>
            <span>Inventario</span>
          </li>
          <li class="nav-item" onclick="showSection('alertas', this)">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Alertas Stock</span>
          </li>
          
          <li class="nav-item" onclick="confirmarCierreCaja()">
            <i class="fas fa-door-closed"></i>
            <span>Cerrar Caja</span>
          </li>
        </ul>
      </nav>

      <main class="content">
        <section id="dashboardSection">
          <div class="card" style="margin-bottom:1rem;">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-tachometer-alt"></i> Dashboard General
              </h2>

              <div class="quick-actions">
                <button class="btn btn-success btn-sm" onclick="showSection('productos'); mostrarModalRegistroProducto()">
                    <i class="fas fa-plus"></i> Agregar producto
                </button>
                <button class="btn btn-primary btn-sm" onclick="showSection('ventas')">
                    <i class="fas fa-cash-register"></i> Registrar venta
                </button>
                <button class="btn btn-warning btn-sm" onclick="showSection('inventario')">
                    <i class="fas fa-boxes-stacked"></i> Actualizar stock
                </button>
                <button class="btn btn-ghost btn-sm" onclick="loadDashboard()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>

                <div class="dropdown">
                    <button type="button" class="btn btn-ghost btn-sm dropdown-toggle" onclick="toggleReportesDropdown(event)">
                        <i class="fas fa-file-alt"></i>
                        <span>Reportes</span>
                        <i class="fas fa-chevron-down" style="font-size:0.75rem;"></i>
                    </button>
                    <div class="dropdown-menu" id="dropdownReportes">
                        <button class="dropdown-item" onclick="generarReporteDashboardClick()">
                            <i class="fas fa-file-pdf"></i> Reporte PDF
                        </button>
                        <button class="dropdown-item" onclick="abrirModalHistorialReportes()">
                            <i class="fas fa-clock"></i> Historial de reportes
                        </button>
                        <button class="dropdown-item" onclick="abrirModalConfigCorreo()">
                            <i class="fas fa-envelope"></i> Env칤o diario por correo
                        </button>
                        
                        </div>
                </div>
              </div>
            </div>

            <div class="filters-panel">
                <div>
                    <label class="form-label">Desde</label>
                    <input type="date" class="form-control" id="fDesde">
                </div>
                <div>
                    <label class="form-label">Hasta</label>
                    <input type="date" class="form-control" id="fHasta">
                </div>
                <div>
                    <label class="form-label">Categor칤a</label>
                    <input type="text" class="form-control" id="fCategoria" placeholder="Ej. Bebidas">
                </div>
                <div>
                    <label class="form-label">Proveedor</label>
                    <input type="text" class="form-control" id="fProveedor" placeholder="Proveedor">
                </div>
                <div>
                    <label class="form-label">Frecuencia</label>
                    <select id="fFrecuencia" class="form-control">
                        <option value="semanal">Semanal (7d)</option>
                        <option value="mensual">Mensual (30d)</option>
                    </select>
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button class="btn btn-primary" onclick="loadDashboard()">
                        <i class="fas fa-filter"></i> Aplicar filtros
                    </button>
                </div>
            </div>
          </div>

          <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-shopping-cart"></i></div>
                <div>
                  <div class="kpi-title">Ventas del d칤a</div>
                  <div class="kpi-value" id="kpiVentasDia">S/ 0.00</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div>
                  <div class="kpi-title">Ingresos del mes</div>
                  <div class="kpi-value" id="kpiIngresosMes">S/ 0.00</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-boxes"></i></div>
                <div>
                  <div class="kpi-title">Productos en stock</div>
                  <div class="kpi-value" id="kpiProductosStock">0</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div>
                  <div class="kpi-title">Por agotarse</div>
                  <div class="kpi-value" id="kpiPorAgotarse">0</div>
                </div>
              </div>
            </div>


          <div class="cards-graphics">
            <div class="chart-card">
              <div class="card-header" style="padding:0; margin-bottom:.5rem; border-bottom:none;">
                <h3 class="card-title">Ventas por categor칤a</h3>
              </div>
              <canvas id="chartCategorias" height="180"></canvas>
            </div>
            <div class="chart-card">
              <div class="card-header" style="padding:0; margin-bottom:.5rem; border-bottom:none;">
                <h3 class="card-title">Tendencia de ventas</h3>
              </div>
              <canvas id="chartTendencia" height="180"></canvas>
            </div>
            <div class="chart-card">
              <div class="card-header" style="padding:0; margin-bottom:.5rem; border-bottom:none;">
                <h3 class="card-title">Top productos</h3>
              </div>
              <canvas id="chartTopProductos" height="180"></canvas>
            </div>
          </div>

          <div class="tables-grid" style="margin-top:1rem;">
            <div class="chart-card">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
                <div class="table-title"><i class="fas fa-trophy"></i> Productos m치s vendidos</div>
                <button class="btn btn-ghost btn-sm" onclick="abrirModalTabla('masVendidos')">
                  <i class="fas fa-expand"></i> Ver todo
                </button>
              </div>

              <table class="table-sm" id="tblMasVendidos">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Categor칤a</th>
                    <th>Unidades</th>
                    <th>Ganancia (S/)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="chart-card">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
                <div class="table-title"><i class="fas fa-exclamation-circle"></i> Bajo stock</div>
                <button class="btn btn-ghost btn-sm" onclick="abrirModalTabla('bajoStock')">
                  <i class="fas fa-expand"></i> Ver todo
                </button>
              </div>

              <table class="table-sm" id="tblBajoStock">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Categor칤a</th>
                    <th>Stock</th>
                    <th>M칤nimo</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="chart-card">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
                <div class="table-title"><i class="fas fa-receipt"></i> 칔ltimos pedidos</div>
                <button class="btn btn-ghost btn-sm" onclick="abrirModalTabla('ultimosPedidos')">
                  <i class="fas fa-expand"></i> Ver todo
                </button>
              </div>
              <div class="table-sm">
                <table class="table-sm" id="tblUltimosPedidos">
                  <thead><tr>
                      <th>Fecha</th><th>Monto (S/)</th><th>Estado</th><th>ID</th>
                  </tr></thead>
                  <tbody id="tblUltimosPedidosBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>


      <div id="modalTablaDashboard" class="modal hidden">
        <div class="modal-content">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" id="modalTablaTitulo">Tabla</h3>
              <button class="btn btn-danger btn-sm" onclick="cerrarModal('modalTablaDashboard')">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="form-group modal-filters">
              <div style="flex:1;">
                <label class="form-label">Filtrar</label>
                <input type="text" class="form-control" id="modalTablaFiltro"
                       placeholder="Escribe parte del nombre, estado, ID, etc.">
              </div>
            </div>

            <div class="table-sm table-modal-wrapper">
              <table>
                <thead id="modalTablaHead"></thead>
                <tbody id="modalTablaBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>


        <section id="ventasSection" class="hidden">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Punto de Venta</h2>
              <span class="text-success" id="estadoVenta">Listo para vender</span>
            </div>
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:2rem;">
              <div>
                <div class="form-group">
                  <label class="form-label">Buscar Producto (C칩digo de Barras o ID)</label>
                  <div style="display: flex; gap: 0.5rem;">
                    <input type="text" class="form-control" id="codigoBarras" placeholder="Ej: 7751234567890 o PRO001"  
                           onkeypress="if(event.key === 'Enter') buscarProducto()">
                    <button class="btn btn-primary" type="button" onclick="buscarProducto()">
                      <i class="fas fa-search"></i> Buscar
                    </button>
                    <button class="btn btn-secondary" type="button" onclick="abrirEscanerVenta()">
                      <i class="fas fa-camera"></i> Escanear
                    </button>
                  </div>
                </div>


                <div id="productoInfo" class="hidden">
                  <div class="card mt-3">
                    <div class="card-header">
                      <h3 class="card-title">Producto Encontrado</h3>
                    </div>
                    <div id="productoDetalles"></div>
                    <div class="form-group">
                      <label class="form-label">Cantidad</label>
                      <input type="number" class="form-control" id="cantidadProducto" value="1" min="1">
                    </div>
                    <button class="btn btn-success" id="btnAgregarCarrito" style="width:100%;">
                      <i class="fas fa-cart-plus"></i> Agregar al Carrito
                    </button>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-header">
                    <h3 class="card-title">Productos Disponibles</h3>
                  </div>
                  <div class="productos-grid" id="listaProductosVenta"></div>
                </div>
              </div>

              <div>
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Carrito de Venta</h3>
                    <button class="btn btn-danger btn-sm" id="btnLimpiarCarrito">
                      <i class="fas fa-trash"></i> Limpiar
                    </button>
                  </div>
                  <div id="carritoItems">
                    <p class="text-center">El carrito est치 vac칤o</p>
                  </div>
                  <div class="cart-total">
                    Total: S/ <span id="totalCarrito">0.00</span>
                  </div>
                  <div class="form-group mt-3">
                    <label class="form-label">M칠todo de Pago</label>
                    <select class="form-control" id="metodoPago">
                      <option value="Efectivo">Efectivo</option>
                      <option value="Yape">Yape</option>
                      <option value="Plin">Plin</option>
                    </select>
                  </div>
                  <button class="btn btn-success" id="btnProcesarVenta" style="width:100%;">
                    <i class="fas fa-check"></i> Procesar Venta
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="productosSection" class="hidden">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Gesti칩n de Inventario</h2>
              <div style="display:flex; gap:0.5rem;">
                <button class="btn btn-primary" onclick="mostrarModalRegistroProducto()">
                  <i class="fas fa-barcode"></i> Registrar Producto
                </button>
                <button class="btn btn-primary" onclick="cargarProductos()">
                  <i class="fas fa-sync-alt"></i> Actualizar
                </button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Buscar Productos</label>
              <div style="display:flex; gap:0.5rem;">
                <input type="text" class="form-control" id="buscarProductoInput"
                       placeholder="Nombre, c칩digo de barras, categor칤a...">
                <button class="btn btn-primary" id="btnBuscarEnLista">
                  <i class="fas fa-search"></i> Buscar
                </button>
              </div>
            </div>

            <div id="listaProductos">
              <p class="text-center">Cargando productos...</p>
            </div>
          </div>
        </section>

        <div id="modalRegistroProducto" class="modal hidden">
          <div class="modal-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Registrar Nuevo Producto</h3>
                <button class="btn btn-danger btn-sm" onclick="cerrarModal('modalRegistroProducto')">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <form id="formRegistroProducto">
                <div class="form-group">
                  <label class="form-label">C칩digo de Barras *</label>
                  <div style="display:flex; gap:0.5rem;">
                    <input type="text" class="form-control" id="codigoBarrasInput"
                           placeholder="Escanear o ingresar manualmente" required>
                    <button type="button" class="btn btn-warning" id="btnEscanear">
                      <i class="fas fa-camera"></i> Escanear
                    </button>
                  </div>
                  <small id="estadoCodigo"></small>
                </div>

                <div id="camaraContenedor" class="hidden" style="margin-bottom:1rem; position:relative;">
                  <div style="position:relative;">
                    <video id="videoCamara"></video>
                    <canvas id="canvasEscaneo" style="display:none;"></canvas>
                    <div class="quagga-overlay">
                      <div class="scan-line"></div>
                      <div class="scanning-indicator">
                        <i class="fas fa-camera"></i> ESCANEANDO...
                      </div>
                    </div>
                  </div>
                  <div style="text-align:center; margin-top:.5rem;">
                    <button type="button" class="btn btn-danger btn-sm" id="btnDetenerEscaneo">
                      <i class="fas fa-stop"></i> Detener Escaneo
                    </button>
                  </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                  <div class="form-group">
                    <label class="form-label">Nombre del Producto *</label>
                    <input type="text" class="form-control" id="nombreProducto" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Categor칤a *</label>
                    <select class="form-control" id="categoriaProducto" required>
                      <option value="">Seleccionar categor칤a</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Precio (S/) *</label>
                    <input type="number" class="form-control" id="precioProducto" step="0.01" min="0" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Stock Inicial</label>
                    <input type="number" class="form-control" id="stockInicial" min="0" value="0">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Stock M칤nimo</label>
                    <input type="number" class="form-control" id="stockMinimo" min="0" value="5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Proveedor</label>
                    <input type="text" class="form-control" id="proveedorProducto" placeholder="Nombre del proveedor">
                  </div>
                </div>

                <div class="form-group" style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem;">
                  <button type="button" class="btn btn-ghost" onclick="cerrarModal('modalRegistroProducto')">
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-success" id="btnRegistrar">
                    <i class="fas fa-save"></i> Registrar Producto
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div id="modalEditarProducto" class="modal hidden">
          <div class="modal-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Editar producto</h3>
                <button class="btn btn-danger btn-sm" onclick="cerrarModal('modalEditarProducto')">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <form id="formEditarProducto" onsubmit="event.preventDefault(); guardarEdicionProducto();">
                <input type="hidden" id="editIdProducto">

                <div class="form-group">
                  <label class="form-label">C칩digo de barras</label>
                  <input type="text" class="form-control" id="editCodigoBarras">
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                  <div class="form-group">
                    <label class="form-label">Nombre del producto *</label>
                    <input type="text" class="form-control" id="editNombreProducto" required>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Precio (S/)</label>
                    <input type="number" class="form-control" id="editPrecioProducto" step="0.01" min="0">
                  </div>

                  <div class="form-group">
                    <label class="form-label">Stock m칤nimo</label>
                    <input type="number" class="form-control" id="editStockMinimo" min="0">
                  </div>

                  <div class="form-group">
                    <label class="form-label">Estado</label>
                    <select class="form-control" id="editEstadoProducto">
                      <option value="Activo">Activo</option>
                      <option value="Inactivo">Inactivo</option>
                    </select>
                  </div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem;">
                  <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalEditarProducto')">
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar cambios
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div id="modalEscanerVenta" class="modal hidden">
          <div class="modal-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Escanear producto para venta</h3>
                <button class="btn btn-danger btn-sm" onclick="cerrarEscanerVenta()">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <div style="position:relative;">
                <video id="videoCamaraVenta" width="100%" height="300" style="background:#000; border-radius:8px;"></video>
                <div class="quagga-overlay">
                  <div class="scan-line"></div>
                  <div class="scanning-indicator">
                    <i class="fas fa-camera"></i> ESCANEANDO...
                  </div>
                </div>
              </div>

              <div style="text-align:center; margin-top:.5rem;">
                <button type="button" class="btn btn-danger btn-sm" onclick="cerrarEscanerVenta()">
                  <i class="fas fa-stop"></i> Detener escaneo
                </button>
              </div>
            </div>
          </div>
        </div>


        <div id="modalHistorialReportes" class="modal hidden">
          <div class="modal-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Historial de reportes</h3>
                <button class="btn btn-danger btn-sm" onclick="cerrarModal('modalHistorialReportes')">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <div class="modal-filters">
                <div>
                  <label class="form-label">Desde</label>
                  <input type="date" class="form-control" id="fRepDesde">
                </div>
                <div>
                  <label class="form-label">Hasta</label>
                  <input type="date" class="form-control" id="fRepHasta">
                </div>
                <div>
                  <label class="form-label">Tipo</label>
                  <input type="text" class="form-control" id="fRepTipo" placeholder="Ej. Dashboard">
                </div>
                <div>
                  <label class="form-label">Generado por</label>
                  <input type="text" class="form-control" id="fRepUsuario" placeholder="Email usuario">
                </div>
                <div style="display:flex; align-items:flex-end;">
                  <button class="btn btn-primary btn-sm" onclick="cargarHistorialReportes()">
                    <i class="fas fa-filter"></i> Aplicar
                  </button>
                </div>
              </div>

              <div class="table-sm table-modal-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Tipo</th>
                      <th>Rango</th>
                      <th>Generado por</th>
                      <th>Archivo</th>
                    </tr>
                  </thead>
                  <tbody id="tblHistorialReportesBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="modalAjustarStock" class="modal hidden">
          <div class="modal-content" style="max-width: 500px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Ajustar Stock Manualmente</h3>
                <button class="btn btn-danger btn-sm" onclick="cerrarModal('modalAjustarStock')">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <form id="formAjustarStock" onsubmit="event.preventDefault(); guardarAjusteStock();">
                <input type="hidden" id="ajusteIdProducto">
                
                <div class="form-group">
                  <label class="form-label">Producto</label>
                  <input type="text" class="form-control" id="ajusteNombreProducto" readonly style="background:#eee;">
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                  <div class="form-group">
                    <label class="form-label">Stock Actual</label>
                    <input type="number" class="form-control" id="ajusteStockActual" readonly style="background:#eee;">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Nuevo Stock *</label>
                    <input type="number" class="form-control" id="ajusteNuevoStock" min="0" required>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Motivo del ajuste *</label>
                  <input type="text" class="form-control" id="ajusteMotivo" placeholder="Ej: Conteo f칤sico, Merma, Devoluci칩n" required>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem;">
                  <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalAjustarStock')">
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar Ajuste
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div id="modalConfigCorreo" class="modal hidden">
          <div class="modal-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Env칤o diario de reporte por correo</h3>
                <button class="btn btn-danger btn-sm" onclick="cerrarModal('modalConfigCorreo')">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <form onsubmit="event.preventDefault(); guardarConfigCorreo();">
                <div class="modal-filters">
                  <div style="flex:1;">
                    <label class="form-label">Correo destino</label>
                    <input type="email" class="form-control" id="cfgEmail" placeholder="ejemplo@correo.com" required>
                  </div>
                  <div>
                    <label class="form-label">Hora diaria</label>
                    <input type="time" class="form-control" id="cfgHora" required>
                  </div>
                  <div style="display:flex; align-items:center; gap:.5rem; margin-top:1.8rem;">
                    <input type="checkbox" id="cfgActivo" checked>
                    <label for="cfgActivo" class="form-label" style="margin-bottom:0;">Activar env칤o diario</label>
                  </div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem;">
                  <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalConfigCorreo')">
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Guardar configuraci칩n
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <section id="inventarioSection" class="hidden">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Movimientos de Inventario</h2>
              <button class="btn btn-primary" id="btnActualizarMovimientos">
                <i class="fas fa-sync-alt"></i> Actualizar
              </button>
            </div>
            <div id="listaMovimientos">
              <p class="text-center">Cargando movimientos...</p>
            </div>
          </div>
        </section>
        
        <section id="alertasSection" class="hidden">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Alertas de Stock Bajo</h2>
              <button class="btn btn-primary" id="btnActualizarAlertas">
                <i class="fas fa-sync-alt"></i> Actualizar
              </button>
            </div>
            <div id="listaAlertas">
              <p class="text-center">Cargando alertas...</p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <footer class="footer">
      <p>Sistema de Gesti칩n &copy; 2025 - Multiservicios Sr. Puerto Malaga</p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <script>
    // ---------- Variables Globales ----------
    let usuarioActual = null;
    let carrito = [];
    let _chartCategorias = null;
    let _chartTendencia = null;
    let _chartTopProductos = null;
    window.quaggaScannerActive = false;

    let _tablaMasVendidos = [];
    let _tablaBajoStock = [];
    let _tablaUltimosPedidos = [];
    let _modalTablaDatosOriginal = [];

    let _historialReportes = [];

    let _configCorreo = null;

    let productosCache = [];
    let productoEnEdicion = null;


    // ---------- L칩gica del Esc치ner (Venta) ----------
    let quaggaVentaActiva = false;
    let streamVenta = null;

    async function abrirEscanerVenta() {
      try {
        console.log('游댌 Esc치ner de venta: iniciando...');

        const modal = document.getElementById('modalEscanerVenta');
        const video = document.getElementById('videoCamaraVenta');

        modal.classList.remove('hidden');

        // Pedir acceso a la c치mara
        streamVenta = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        video.srcObject = streamVenta;
        await video.play();

        // Inicializar Quagga
        await new Promise((resolve, reject) => {
          Quagga.init({
            inputStream: {
              name: 'Live',
              type: 'LiveStream',
              target: video,
              constraints: {
                facingMode: 'environment',
                width: 640,
                height: 480
              }
            },
            decoder: {
              readers: [
                'ean_reader',
                'ean_8_reader',
                'upc_reader',
                'code_128_reader',
                'code_39_reader'
              ]
            },
            locator: {
              patchSize: 'medium',
              halfSample: true
            }
          }, function(err) {
            if (err) {
              console.error('Error iniciando Quagga (venta):', err);
              reject(err);
              return;
            }
            resolve();
          });
        });

        Quagga.start();
        quaggaVentaActiva = true;

        Quagga.onDetected(onCodigoDetectadoVenta);

        Swal.fire({
          title: 'Esc치ner activado',
          html: 'Enfoca el c칩digo de barras del producto. Se detectar치 autom치ticamente.',
          icon: 'info',
          timer: 2500,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('Error en esc치ner de venta:', error);
        Swal.fire(
          'Error de c치mara',
          'No se pudo acceder a la c치mara. Revisa los permisos del navegador.',
          'error'
        );
        cerrarEscanerVenta();
      }
    }

    function onCodigoDetectadoVenta(result) {
      if (!result || !result.codeResult || !result.codeResult.code) return;

      const codigo = result.codeResult.code;
      console.log('游닝 C칩digo detectado (venta):', codigo);

      if (!/^\d+$/.test(codigo)) return;

      // Rellenar input y buscar producto
      document.getElementById('codigoBarras').value = codigo;
      cerrarEscanerVenta();

      Swal.fire({
        title: 'C칩digo detectado',
        html: `<strong>${codigo}</strong>`,
        icon: 'success',
        timer: 1500,
        showConfirmButton: false
      });

      // Ejecutar flujo normal de b칰squeda
      buscarProducto();
    }

    function cerrarEscanerVenta() {
      const modal = document.getElementById('modalEscanerVenta');
      modal.classList.add('hidden');

      if (quaggaVentaActiva) {
        try {
          Quagga.offDetected(onCodigoDetectadoVenta);
          Quagga.stop();
        } catch (e) {
          console.warn('Error al detener Quagga (venta):', e);
        }
        quaggaVentaActiva = false;
      }

      if (streamVenta) {
        streamVenta.getTracks().forEach(t => t.stop());
        streamVenta = null;
      }
    }
    
    // ---------- Inicializaci칩n y Eventos ----------
    window.addEventListener('load', () => {
      const loginForm = document.getElementById('loginForm');
      const btnLogout = document.getElementById('btnLogout');

      if (loginForm) {
        loginForm.addEventListener('submit', onLoginSubmit);
      }
      if (btnLogout) {
        btnLogout.addEventListener('click', logout);
      }

      // Punto de venta
      const btnBuscarProducto = document.getElementById('btnBuscarProducto');
      const btnAgregarCarrito = document.getElementById('btnAgregarCarrito');
      const btnLimpiarCarrito = document.getElementById('btnLimpiarCarrito');
      const btnProcesarVenta = document.getElementById('btnProcesarVenta');

      if (btnBuscarProducto) btnBuscarProducto.addEventListener('click', buscarProducto);
      const codigoBarras = document.getElementById('codigoBarras');
      if (codigoBarras) {
        codigoBarras.addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            buscarProducto();
          }
        });
      }
      if (btnAgregarCarrito) btnAgregarCarrito.addEventListener('click', agregarAlCarrito);
      if (btnLimpiarCarrito) btnLimpiarCarrito.addEventListener('click', limpiarCarrito);
      if (btnProcesarVenta) btnProcesarVenta.addEventListener('click', procesarVenta);

      // Productos
      const buscarProductoInput = document.getElementById('buscarProductoInput');
      const btnBuscarEnLista = document.getElementById('btnBuscarEnLista');
      if (btnBuscarEnLista) btnBuscarEnLista.addEventListener('click', buscarProductos);
      if (buscarProductoInput) {
        buscarProductoInput.addEventListener('keyup', e => {
          if (e.key === 'Enter') buscarProductos();
        });
      }

      // Inventario / Alertas
      const btnActualizarMovimientos = document.getElementById('btnActualizarMovimientos');
      const btnActualizarAlertas = document.getElementById('btnActualizarAlertas');
      if (btnActualizarMovimientos) btnActualizarMovimientos.addEventListener('click', cargarMovimientos);
      if (btnActualizarAlertas) btnActualizarAlertas.addEventListener('click', cargarAlertas);

      // Esc치ner / registro productos
      const codigoBarrasInput = document.getElementById('codigoBarrasInput');
      const btnEscanear = document.getElementById('btnEscanear');
      const btnDetenerEscaneo = document.getElementById('btnDetenerEscaneo');
      const formRegistroProducto = document.getElementById('formRegistroProducto');

      if (codigoBarrasInput) {
        codigoBarrasInput.addEventListener('input', () => {
          if (codigoBarrasInput.value.length > 5) {
            verificarCodigoBarras();
          }
        });
      }
      if (btnEscanear) btnEscanear.addEventListener('click', iniciarEscaneo);
      if (btnDetenerEscaneo) btnDetenerEscaneo.addEventListener('click', detenerEscaneo);
      if (formRegistroProducto) {
        formRegistroProducto.addEventListener('submit', e => {
          e.preventDefault();
          registrarProducto();
        });
      }
    });

    // ---------- L칩gica de Login/Logout ----------
    function onLoginSubmit(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      google.script.run
        .withSuccessHandler(usuario => {
          if (usuario) {
            usuarioActual = usuario;
            document.getElementById('userName').textContent =
              (usuario.Nombre || 'Usuario') + ' - ' + (usuario.Rol || '');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            loadDashboard();
            cargarProductosParaVenta();
            Swal.fire('춰칄xito!', `Bienvenido ${usuario.Nombre}`, 'success');
          } else {
            Swal.fire('Error', 'Credenciales incorrectas. Usa: admin@tienda.com / admin123', 'error');
          }
        })
        .withFailureHandler(error => {
          console.error('Error login:', error);
          Swal.fire('Error', 'Error de conexi칩n: ' + error.message, 'error');
        })
        .loginUsuario(email, password);
    }

    function logout() {
      usuarioActual = null;
      carrito = [];
      document.getElementById('appScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginForm').reset();
    }

    // ---------- Navegaci칩n ----------
    function showSection(sectionName, el) {
      document.querySelectorAll('main section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(sectionName + 'Section').classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      if (el && el.classList) el.classList.add('active');

      switch (sectionName) {
        case 'dashboard': loadDashboard(); break;
        case 'ventas': cargarProductosParaVenta(); break;
        case 'productos': cargarProductos(); break;
        case 'inventario': cargarMovimientos(); break;
        case 'alertas': cargarAlertas(); break;
      }
    }

    // ---------- L칩gica del Dashboard ----------
    function getFilters() {
        const desde = document.getElementById('fDesde')?.value || '';
        const hasta = document.getElementById('fHasta')?.value || '';
        const categoria = document.getElementById('fCategoria')?.value || '';
        const proveedor = document.getElementById('fProveedor')?.value || '';
        const frecuencia = document.getElementById('fFrecuencia')?.value || 'semanal';
        return { desde, hasta, categoria, proveedor, frecuencia };
    }


    function loadDashboard() {
      const filtros = getFilters();
      google.script.run
        .withSuccessHandler(renderDashboard)
        .withFailureHandler(err => {
          console.error('Dashboard error:', err);
          Swal.fire('Error', 'No se pudo cargar el dashboard', 'error');
        })
        .getDashboardData(filtros);
    }

    function renderDashboard(data) {
      // KPIs
      document.getElementById('kpiVentasDia').textContent =
        `S/ ${Number(data.kpis.ventasDia || 0).toFixed(2)}`;
      document.getElementById('kpiIngresosMes').textContent =
        `S/ ${Number(data.kpis.ingresosMes || 0).toFixed(2)}`;
      document.getElementById('kpiProductosStock').textContent =
        Number(data.kpis.productosEnStock || 0);
      document.getElementById('kpiPorAgotarse').textContent =
        Number(data.kpis.porAgotarse || 0);
      

      // Guardar datos de tablas a nivel global para el modal
      _tablaMasVendidos   = data.tablas.masVendidos   || [];
      _tablaBajoStock     = data.tablas.bajoStock     || [];
      _tablaUltimosPedidos = data.tablas.ultimosPedidos || [];

      // Gr치ficos
      drawChartCategorias(data.charts.porCategoria || []);
      drawChartTendencia(data.charts.tendencia || []);
      drawChartTopProductos(data.charts.topProductos || []);

      // Tablas en miniatura (dashboard)
        fillTable('#tblMasVendidos tbody', (data.tablas.masVendidos || []).map(r => ([
        r.nombre,
        r.categoria,
        r.unidades,
        Number(r.ganancia || 0).toFixed(2)
        ])));

        fillTable('#tblBajoStock tbody', (data.tablas.bajoStock || []).map(r => ([
        r.nombre,
        r.categoria,
        `<span class="badge badge-danger">${r.stock}</span>`,
        r.minimo
        ])));

        fillTable('#tblUltimosPedidos tbody', (data.tablas.ultimosPedidos || []).map(r => ([
        formatearFechaCorta(r.fecha),
        Number(r.monto || 0).toFixed(2),
        `<span class="badge">${r.estado || ''}</span>`,
        r.id || ''
        ])));
    }

    function parseFechaJs(valor) {
      if (!valor) return null;

      if (Object.prototype.toString.call(valor) === '[object Date]') {
        return isNaN(valor.getTime()) ? null : valor;
      }

      // Detectar si es n칰mero serial de Sheets (ej. 45321.65)
      if (!isNaN(valor) && typeof valor !== 'string') {
        const base = new Date(1899, 11, 30);
        base.setDate(base.getDate() + Number(valor));
        return base;
      }
      
      // Si es string (ej. 2025-11-06T14:30:00.000Z)
      const d = new Date(valor);
      return isNaN(d.getTime()) ? null : d;
    }

    function formatearFechaCorta(valor) {
      const d = parseFechaJs(valor);
      if (!d) return '';

      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');

      return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
    }

    function abrirModalTabla(tipo) {
      const titulo = document.getElementById('modalTablaTitulo');
      const head   = document.getElementById('modalTablaHead');
      const body   = document.getElementById('modalTablaBody');
      const filtro = document.getElementById('modalTablaFiltro');

      let columnas = [];
      let datos = [];

      if (tipo === 'masVendidos') {
        titulo.textContent = 'Productos m치s vendidos';
        columnas = ['Producto', 'Categor칤a', 'Unidades', 'Ganancia (S/)'];
        datos = _tablaMasVendidos.map(r => [
          r.nombre,
          r.categoria,
          String(r.unidades),
          Number(r.ganancia || 0).toFixed(2)
        ]);
      } else if (tipo === 'bajoStock') {
        titulo.textContent = 'Productos con bajo stock';
        columnas = ['Producto', 'Categor칤a', 'Stock', 'M칤nimo'];
        datos = _tablaBajoStock.map(r => [
          r.nombre,
          r.categoria,
          String(r.stock),
          String(r.minimo)
        ]);
      } else if (tipo === 'ultimosPedidos') {
        titulo.textContent = '칔ltimos pedidos';
        columnas = ['Fecha', 'Monto (S/)', 'Estado', 'ID']; // Columna Cliente removida por ahora
        datos = _tablaUltimosPedidos.map(r => [
          formatearFechaCorta(r.fecha),
          Number(r.monto || 0).toFixed(2),
          r.estado,
          r.id
        ]);
      }

      _modalTablaDatosOriginal = datos;

      // Pintar cabecera
      head.innerHTML = '<tr>' + columnas.map(c => `<th>${c}</th>`).join('') + '</tr>';

      // Funci칩n interna para renderizar con filtro
      const renderFiltrado = () => {
        const term = (filtro.value || '').toLowerCase();
        body.innerHTML = '';
        _modalTablaDatosOriginal
          .filter(row => row.join(' ').toLowerCase().includes(term))
          .forEach(row => {
            const tr = document.createElement('tr');
            row.forEach(cell => {
              const td = document.createElement('td');
              td.innerHTML = cell;
              tr.appendChild(td);
            });
            body.appendChild(tr);
          });
      };

      filtro.value = '';
      filtro.oninput = renderFiltrado;
      renderFiltrado();

      document.getElementById('modalTablaDashboard').classList.remove('hidden');
    }



    function fillTableBody(tbodyId, rows) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) {
        console.error('No se encontr칩 tbody con id:', tbodyId);
        return;
      }

      // limpiar siempre
      tbody.innerHTML = '';

      // cu치ntas columnas tiene la tabla (seg칰n el thead)
      const thead = tbody.parentElement.querySelector('thead');
      const columnas = thead ? thead.querySelectorAll('th').length : 1;

      // si no hay filas, mostrar mensaje
      if (!rows || !rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${columnas}" style="padding:.7rem; text-align:center; color:#6b7280;">
          Sin datos
        </td>`;
        tbody.appendChild(tr);
        return;
      }

      // pintar filas
      rows.forEach(r => {
        const tr = document.createElement('tr');
        r.forEach(cell => {
          const td = document.createElement('td');
          td.innerHTML = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }


    function fillTable(selector, rows) {
      const tbody = document.querySelector(selector);
      if (!tbody) {
        console.error('No se encontr칩 el elemento:', selector);
        return;
      }

      // limpiar siempre
      tbody.innerHTML = '';

      // cu치ntas columnas tiene la tabla (miramos el thead del mismo <table>)
      const table = tbody.closest('table');
      const thead = table ? table.querySelector('thead') : null;
      const columnas = thead ? thead.querySelectorAll('th').length : 1;

      // si no hay filas, mostramos mensaje
      if (!rows || !rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${columnas}" style="padding:.7rem; text-align:center; color:#6b7280;">
          Sin datos
        </td>`;
        tbody.appendChild(tr);
        return;
      }

      // pintar filas
      rows.forEach(r => {
        const tr = document.createElement('tr');
        r.forEach(cell => {
          const td = document.createElement('td');
          td.innerHTML = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }


    function drawChartCategorias(data) {
      const ctx = document.getElementById('chartCategorias').getContext('2d');
      if (_chartCategorias) _chartCategorias.destroy();
      _chartCategorias = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(x => x.categoria),
          datasets: [{ label: 'Ventas (S/)', data: data.map(x => x.total) }]
        },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function drawChartTendencia(data) {
      const ctx = document.getElementById('chartTendencia').getContext('2d');
      if (_chartTendencia) _chartTendencia.destroy();
      _chartTendencia = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(x => x.label),
          datasets: [{ label: 'Ingresos (S/)', data: data.map(x => x.total), tension:.3 }]
        },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function drawChartTopProductos(data) {
      const ctx = document.getElementById('chartTopProductos').getContext('2d');
      if (_chartTopProductos) _chartTopProductos.destroy();
      _chartTopProductos = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.map(x => x.nombre),
          datasets: [{ label: 'Ventas (S/)', data: data.map(x => x.total) }]
        },
        options: { responsive:true }
      });
    }

    // ---------- L칩gica del Punto de Venta (POS) ----------
    function buscarProducto() {
      const codigo = document.getElementById('codigoBarras').value.trim();
      if (!codigo) {
        Swal.fire('Error', 'Ingrese un c칩digo de barras o ID de producto', 'warning');
        return;
      }
      google.script.run
        .withSuccessHandler(producto => {
          if (producto) {
            const stock = parseInt(producto.Stock_Actual) || 0;
            const stockClass = stock <= 5 ? 'text-danger' : 'text-success';
            document.getElementById('productoDetalles').innerHTML = `
              <div class="cart-item">
                <div>
                  <strong>${producto.Nombre_Producto}</strong>
                  <div>Precio: S/ ${producto.Precio}</div>
                  <div class="${stockClass}">Stock disponible: ${stock}</div>
                  <div>C칩digo: ${producto.Codigo_Barras}</div>
                </div>
                <span class="text-success">S/ ${producto.Precio}</span>
              </div>`;
            document.getElementById('productoInfo').classList.remove('hidden');
            const btn = document.getElementById('btnAgregarCarrito');
            if (stock <= 0) {
              btn.disabled = true;
              btn.innerHTML = '<i class="fas fa-times"></i> Sin stock';
            } else {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-cart-plus"></i> Agregar al Carrito';
            }
          } else {
            Swal.fire('Error', 'Producto no encontrado. Verifica el c칩digo.', 'error');
            document.getElementById('productoInfo').classList.add('hidden');
          }
        })
        .getProductoByCodigo(codigo);
    }

    function agregarAlCarrito() {
      const codigo = document.getElementById('codigoBarras').value.trim();
      const cantidad = parseInt(document.getElementById('cantidadProducto').value) || 1;
      if (!codigo) {
        Swal.fire('Error', 'Primero busca un producto', 'warning');
        return;
      }
      google.script.run
        .withSuccessHandler(producto => {
          if (!producto) return;
          const stockDisponible = parseInt(producto.Stock_Actual) || 0;
          if (cantidad > stockDisponible) {
            Swal.fire('Error', `Stock insuficiente. Solo hay ${stockDisponible} unidades`, 'error');
            return;
          }
          const item = carrito.find(i => i.idProducto === producto.ID_Producto);
          if (item) {
            item.cantidad += cantidad;
            item.subtotal = item.cantidad * parseFloat(producto.Precio);
          } else {
            carrito.push({
              idProducto: producto.ID_Producto,
              nombre: producto.Nombre_Producto,
              precio: parseFloat(producto.Precio),
              cantidad,
              subtotal: parseFloat(producto.Precio) * cantidad
            });
          }
          actualizarCarrito();
          document.getElementById('codigoBarras').value = '';
          document.getElementById('cantidadProducto').value = 1;
          document.getElementById('productoInfo').classList.add('hidden');
          Swal.fire('춰칄xito!', 'Producto agregado al carrito', 'success');
        })
        .getProductoByCodigo(codigo);
    }

    function actualizarCarrito() {
      const cont = document.getElementById('carritoItems');
      const totalSpan = document.getElementById('totalCarrito');
      cont.innerHTML = '';
      if (carrito.length === 0) {
        cont.innerHTML = '<p class="text-center">El carrito est치 vac칤o</p>';
        totalSpan.textContent = '0.00';
        return;
      }
      let total = 0;
      carrito.forEach((item, idx) => {
        total += item.subtotal;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div>
            <strong>${item.nombre}</strong>
            <div>S/ ${item.precio.toFixed(2)} x ${item.cantidad}</div>
          </div>
          <div style="display:flex; align-items:center; gap:.5rem;">
            <span>S/ ${item.subtotal.toFixed(2)}</span>
            <button class="btn btn-danger btn-sm" onclick="removerDelCarrito(${idx})">
              <i class="fas fa-trash"></i>
            </button>
          </div>`;
        cont.appendChild(div);
      });
      totalSpan.textContent = total.toFixed(2);
    }

    function removerDelCarrito(index) {
      carrito.splice(index, 1);
      actualizarCarrito();
    }

    function limpiarCarrito() {
      carrito = [];
      actualizarCarrito();
      Swal.fire('Carrito limpiado', 'Todos los productos fueron removidos', 'info');
    }

    function procesarVenta() {
      if (carrito.length === 0) {
        Swal.fire('Error', 'El carrito est치 vac칤o', 'warning');
        return;
      }
      const metodoPago = document.getElementById('metodoPago').value;
      const total = carrito.reduce((s, i) => s + i.subtotal, 0);
      const ventaData = {
        idCajero: usuarioActual.ID_Usuario,
        total,
        metodoPago
      };
      Swal.fire({
        title: 'Confirmar Venta',
        html: `
          <p>Total: <strong>S/ ${total.toFixed(2)}</strong></p>
          <p>M칠todo de pago: <strong>${metodoPago}</strong></p>
          <p>Productos: ${carrito.length}</p>
          <p>쮺onfirmar esta venta?</p>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S칤, procesar venta',
        cancelButtonText: 'Cancelar'
      }).then(res => {
        if (!res.isConfirmed) return;
        google.script.run
          .withSuccessHandler(idVenta => {
            Swal.fire('춰칄xito!', `Venta registrada con ID: ${idVenta}`, 'success');
            carrito = [];
            actualizarCarrito();
            loadDashboard();
            document.getElementById('codigoBarras').value = '';
          })
          .withFailureHandler(err => {
            console.error('Error venta:', err);
            Swal.fire('Error', 'No se pudo procesar la venta: ' + err.message, 'error');
          })
          .registrarVenta(ventaData, carrito);
      });
    }

    function cargarProductosParaVenta() {
      google.script.run
        .withSuccessHandler(productos => {
          const lista = document.getElementById('listaProductosVenta');
          lista.innerHTML = '';
          if (!productos || productos.length === 0) {
            lista.innerHTML = '<p class="text-center">No hay productos disponibles</p>';
            return;
          }
          productos.forEach(p => {
            const stock = parseInt(p.Stock_Actual) || 0;
            const stockClass = stock <= 5 ? 'stock-bajo' : '';
            const div = document.createElement('div');
            div.className = `producto-venta ${stockClass}`;
            div.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <strong>${p.Nombre_Producto}</strong>
                  <div>S/ ${p.Precio} | C칩digo: ${p.Codigo_Barras}</div>
                  <div class="${stock <= 5 ? 'text-danger' : 'text-success'}">Stock: ${stock}</div>
                </div>
                <button class="btn btn-primary btn-sm" onclick="agregarProductoRapido('${p.ID_Producto}')">
                  <i class="fas fa-cart-plus"></i>
                </button>
              </div>`;
            lista.appendChild(div);
          });
        })
        .getProductos();
    }

    function agregarProductoRapido(idProducto) {
      const input = document.getElementById('codigoBarras');
      input.value = idProducto;
      buscarProducto();
    }

    // ---------- Gesti칩n de Productos e Inventario ----------
    function cargarProductos() {
      google.script.run.withSuccessHandler(function(productos) {
        const lista = document.getElementById('listaProductos');
        lista.innerHTML = '';
        productosCache = productos || [];

        if (!productos || productos.length === 0) {
          lista.innerHTML = '<p class="text-center">No hay productos registrados</p>';
          return;
        }

        productos.forEach(producto => {
          const stock = parseInt(producto.Stock_Actual) || 0;
          const stockMinimo = parseInt(producto.Stock_Minimo) || 5;
          const stockClass = stock <= stockMinimo ? 'stock-bajo' : 'stock-normal';
          const estado = producto.Estado || 'Activo';
          const esInactivo = String(estado).toLowerCase() === 'inactivo';

          const div = document.createElement('div');
          div.className = `producto-item ${stockClass}`;
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.style.gap = '1rem';
          div.style.padding = '1rem';
          div.style.borderBottom = '1px solid #eee';

          div.innerHTML = `
            <div style="flex:1;">
              <strong>${producto.Nombre_Producto || 'Sin nombre'}</strong>
              <div>ID: ${producto.ID_Producto} | C칩digo: ${producto.Codigo_Barras || ''}</div>
              <div>Precio: S/ ${producto.Precio || '0.00'} | Categor칤a: ${producto.Categoria || ''}</div>
              <div>Stock: ${producto.Stock_Actual || 0} | M칤nimo: ${producto.Stock_Minimo || 0}</div>
              <div>Proveedor: ${producto.Proveedor || ''} | 
                Estado: <span class="badge ${esInactivo ? 'badge-danger' : ''}">${estado}</span>
              </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:.3rem;">
              <button class="btn btn-ghost btn-sm" onclick="abrirModalEditarProducto('${producto.ID_Producto}')">
                <i class="fas fa-edit"></i> Editar
              </button>

             <button class="btn btn-warning btn-sm" onclick="abrirModalAjustarStock('${producto.ID_Producto}')">
                <i class="fas fa-warehouse"></i> Ajustar Stock
             </button>
                    <button class="btn btn-danger btn-sm" onclick="confirmarEliminarProducto('${producto.ID_Producto}')">
                <i class="fas fa-trash"></i> Desactivar
              </button>
            </div>
          `;

          lista.appendChild(div);
        });
      }).getProductos();
    }


    function buscarProductos() {
      const termino = document.getElementById('buscarProductoInput').value || '';
      google.script.run
        .withSuccessHandler(productos => {
          const lista = document.getElementById('listaProductos');
          lista.innerHTML = '';
          if (!productos || productos.length === 0) {
            lista.innerHTML = '<p class="text-center">No hay resultados</p>';
            return;
          }
          productos.forEach(p => {
            const stock = parseInt(p.Stock_Actual) || 0;
            const min = parseInt(p.Stock_Minimo) || 5;
            const cls = stock <= min ? 'stock-bajo' : 'stock-normal';
            const div = document.createElement('div');
            div.className = `cart-item ${cls}`;
            div.innerHTML = `
              <div>
                <strong>${p.Nombre_Producto}</strong>
                <div>ID: ${p.ID_Producto} | C칩digo: ${p.Codigo_Barras}</div>
                <div>Precio: S/ ${p.Precio}</div>
                <div>Stock: ${p.Stock_Actual} | M칤nimo: ${p.Stock_Minimo}</div>
              </div>`;
            lista.appendChild(div);
          });
        })
        .buscarProductos(termino);
    }

    function cargarMovimientos() {
      google.script.run
        .withSuccessHandler(movs => {
          const lista = document.getElementById('listaMovimientos');
          lista.innerHTML = '';
          
          if (!movs || movs.length === 0) {
            lista.innerHTML = '<p class="text-center">No hay movimientos de inventario</p>';
            return;
          }

          movs.slice(0, 50).forEach(m => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            
            const cantidad = parseInt(m.Cantidad) || 0;
            const esEntrada = cantidad >= 0;
            const colorClase = esEntrada ? 'text-success' : 'text-danger';
            const cantidadStr = esEntrada ? `+${cantidad}` : `${cantidad}`;

            // --- L칩gica de Motivo (Defensiva) ---
            var motivoDisplay = '';
            if (m.Motivo && m.Motivo.toLowerCase().startsWith('venta:')) {
                motivoDisplay = m.Motivo; // Muestra "Venta: VTA001"
            } else if (m.Motivo) {
                  motivoDisplay = m.Motivo; // Muestra "Ajuste manual: ..."
            } else {
                // Fallback: Nombre del motivo, o ID del motivo, o texto gen칠rico
                motivoDisplay = m.Nombre_Motivo || m.ID_Motivo || 'Ajuste de Sistema';
            }

            // --- L칩gica de Nombres (Defensiva) ---
            // Si m.Nombre_Producto no existe, usa "Producto" como fallback
            const nombreProd = m.Nombre_Producto || 'Producto';
            
            // Si m.Nombre_Tipo no existe, usa el ID (TIPO001) o "Movimiento"
            const nombreTipo = m.Nombre_Tipo || m.ID_Tipo_Movimiento || 'Movimiento';
            
            // Si m.Nombre_Usuario no existe, usa "Usuario"
            const nombreUser = m.Nombre_Usuario || 'Usuario';
            

            // --- HTML final (Totalmente Defensivo) ---
            div.innerHTML = `
              <div>
                <strong>${nombreProd} (${m.ID_Producto})</strong>
                
                <div style="font-weight: bold;" class="${colorClase}">
                  ${nombreTipo} (${cantidadStr} unidades)
                </div>

                <div>Motivo: ${motivoDisplay}</div>
                
                <div>Usuario: ${nombreUser} (${m.ID_Usuario})</div> 

                <div>Fecha: ${formatearFechaCorta(m.Fecha_Movimiento)}</div>
              </div>
              <span class="${colorClase}" style="font-size: 1.5rem; font-weight:bold;">
                 ${esEntrada ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>'}
              </span>`;
            lista.appendChild(div);
          });
        })
        .withFailureHandler(err => {
          console.error('Error cargando movimientos:', err);
          Swal.fire('Error', 'No se pudieron cargar los movimientos', 'error');
        })
        .getMovimientosInventario();
    }

    function cargarAlertas() {
      google.script.run
        .withSuccessHandler(alertas => {
          const lista = document.getElementById('listaAlertas');
          lista.innerHTML = '';
          if (!alertas || alertas.length === 0) {
            lista.innerHTML = '<p class="text-center text-success">No hay alertas de stock bajo</p>';
            return;
          }
          alertas.forEach(a => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.style.background = '#FFE5E5';
            div.innerHTML = `
              <div>
                <strong>${a.Nombre_Producto}</strong>
                <div class="text-danger">Stock Actual: ${a.Stock_Actual}</div>
                <div>Stock M칤nimo: ${a.Stock_Minimo}</div>
                <div class="text-danger">Diferencia: ${a.Diferencia}</div>
              </div>
              <span class="text-danger"><i class="fas fa-exclamation-triangle"></i></span>`;
            lista.appendChild(div);
          });
        })
        .getAlertasStock();
    }

    // ---------- L칩gica de Registro y Modales ----------
    function mostrarModalRegistroProducto() {
      document.getElementById('formRegistroProducto').reset();
      document.getElementById('estadoCodigo').textContent = '';
      document.getElementById('camaraContenedor').classList.add('hidden');
      document.getElementById('btnRegistrar').disabled = false;
      document.getElementById('modalRegistroProducto').classList.remove('hidden');
      cargarCategoriasModal();
    }

    function cargarCategoriasModal(preselectedId) {
      console.log("游늶 Cargando categor칤as...");

      const select = document.getElementById('categoriaProducto');

      if (!select) {
        console.error("仇 ERROR: No se encontr칩 el elemento 'categoriaProducto'");
        return;
      }

      select.innerHTML = '<option value="">Seleccionar categor칤a</option>';
      select.disabled = true;

      google.script.run
        .withSuccessHandler(function(categorias) {
          console.log("九 Categor칤as recibidas:", categorias);

          if (!Array.isArray(categorias) || categorias.length === 0) {
            categorias = [];
          }

          categorias.forEach(function(cat) {
            // Soporta tanto objetos como strings por si acaso
            let id, nombre;
            if (typeof cat === 'string') {
              id = cat;
              nombre = cat;
            } else {
              id = cat.id;
              nombre = cat.nombre;
            }
            if (!id || !nombre) return;

            const option = document.createElement('option');
            option.value = id;
            option.textContent = nombre;
            select.appendChild(option);
          });

          // Opci칩n especial para crear nueva categor칤a
          const optNueva = document.createElement('option');
          optNueva.value = '__nueva__';
          optNueva.textContent = '俱 Crear nueva categor칤a...';
          select.appendChild(optNueva);

          select.disabled = false;

          // Seleccionar categor칤a si se pas칩 ID despu칠s de crear una nueva
          if (preselectedId) {
            select.value = preselectedId;
          } else {
            select.value = '';
          }
        })
        .withFailureHandler(function(error) {
          console.error("仇 Error cargando categor칤as:", error);
          select.disabled = false;
        })
        .getCategoriasProductos();
    }

    function solicitarNuevaCategoria() {
      Swal.fire({
        title: 'Nueva categor칤a',
        input: 'text',
        inputLabel: 'Nombre de la categor칤a',
        inputPlaceholder: 'Ej. Bebidas, L치cteos, Snacks...',
        showCancelButton: true,
        confirmButtonText: 'Crear',
        cancelButtonText: 'Cancelar',
        inputValidator: (value) => {
          if (!value || !value.trim()) {
            return 'Ingresa un nombre v치lido';
          }
          if (value.trim().length > 50) {
            return 'El nombre es muy largo (m치x. 50 caracteres)';
          }
        }
      }).then(result => {
        if (!result.isConfirmed) return;

        const nombre = result.value.trim();

        google.script.run
          .withSuccessHandler(function(resp) {
            if (!resp || !resp.success) {
              Swal.fire('Error', (resp && resp.error) || 'No se pudo crear la categor칤a', 'error');
              return;
            }

            Swal.fire('Listo', 'Categor칤a creada correctamente', 'success');
            // Volvemos a cargar las categor칤as y seleccionamos la nueva
            cargarCategoriasModal(resp.idCategoria);
          })
          .withFailureHandler(function(error) {
            Swal.fire('Error', 'Error al crear la categor칤a: ' + error.message, 'error');
          })
          .crearCategoria(nombre);
      });
    }

    async function iniciarEscaneo() {
      try {
        if (window.quaggaScannerActive) detenerEscaneo();
        const video = document.getElementById('videoCamara');
        document.getElementById('camaraContenedor').classList.remove('hidden');
        document.getElementById('btnEscanear').disabled = true;

        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }
        });
        video.srcObject = stream;
        video.play();

        await new Promise((resolve, reject) => {
          Quagga.init({
            inputStream: {
              name:'Live',
              type:'LiveStream',
              target: video,
              constraints:{ width:640, height:480, facingMode:'environment' }
            },
            decoder: {
              readers:['ean_reader','ean_8_reader','upc_reader','code_128_reader','code_39_reader']
            },
            locator:{ patchSize:'medium', halfSample:true }
          }, err => err ? reject(err) : resolve());
        });

        Quagga.start();
        window.quaggaScannerActive = true;

        Quagga.onDetected(result => {
          if (!result || !result.codeResult || !result.codeResult.code) return;
          const code = result.codeResult.code;
          if (/^\d+$/.test(code)) {
            document.getElementById('codigoBarrasInput').value = code;
            verificarCodigoBarras();
            detenerEscaneo();
            Swal.fire({
              title:'C칩digo detectado',
              html:`<strong>${code}</strong>`,
              icon:'success',
              timer:2000,
              showConfirmButton:false
            });
          }
        });
      } catch (error) {
        console.error('Error esc치ner:', error);
        Swal.fire('Error de c치mara',
          'No se pudo acceder a la c치mara. Revisa permisos y HTTPS.<br><small>' + error.message + '</small>',
          'error');
        detenerEscaneo();
      }
    }

    function detenerEscaneo() {
      if (window.quaggaScannerActive) {
        Quagga.stop();
        Quagga.offDetected();
        window.quaggaScannerActive = false;
      }
      document.getElementById('camaraContenedor').classList.add('hidden');
      const video = document.getElementById('videoCamara');
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      const btn = document.getElementById('btnEscanear');
      if (btn) btn.disabled = false;
    }

    function verificarCodigoBarras() {
      const codigo = document.getElementById('codigoBarrasInput').value.trim();
      const estado = document.getElementById('estadoCodigo');
      if (codigo.length < 3) {
        estado.textContent = '';
        return;
      }
      if (codigo.length >= 8 && !isNaN(codigo)) {
        estado.innerHTML = `<span class="text-success">Formato v치lido</span>`;
      } else {
        estado.innerHTML = `<span class="text-warning">Formato inusual</span>`;
      }
      google.script.run
        .withSuccessHandler(prod => {
          if (prod) {
            estado.innerHTML = `<span class="text-danger">C칩digo ya registrado: ${prod.Nombre_Producto}</span>`;
            document.getElementById('btnRegistrar').disabled = true;
          } else {
            estado.innerHTML = `<span class="text-success">C칩digo disponible</span>`;
            document.getElementById('btnRegistrar').disabled = false;
          }
        })
        .withFailureHandler(() => {
          estado.innerHTML = `<span class="text-warning">Error verificando c칩digo</span>`;
        })
        .verificarCodigoBarras(codigo);
    }

    function registrarProducto() {
      const productoData = {
        codigoBarras: document.getElementById('codigoBarrasInput').value.trim(),
        nombre: document.getElementById('nombreProducto').value.trim(),
        categoria: document.getElementById('categoriaProducto').value,
        precio: document.getElementById('precioProducto').value,
        stockInicial: document.getElementById('stockInicial').value,
        stockMinimo: document.getElementById('stockMinimo').value,
        proveedor: document.getElementById('proveedorProducto').value.trim(),
        idUsuario: usuarioActual?.ID_Usuario
      };
      if (!productoData.codigoBarras) {
        Swal.fire('Error','El c칩digo de barras es obligatorio','error'); return;
      }
      if (!productoData.nombre) {
        Swal.fire('Error','El nombre del producto es obligatorio','error'); return;
      }
      if (!productoData.categoria) {
        Swal.fire('Error','Debes seleccionar una categor칤a','error'); return;
      }
      if (!productoData.precio || parseFloat(productoData.precio) <= 0) {
        Swal.fire('Error','El precio debe ser mayor a 0','error'); return;
      }

      Swal.fire({
        title:'Registrando producto...',
        text:'Por favor espere',
        allowOutsideClick:false,
        didOpen:() => Swal.showLoading()
      });

      google.script.run
        .withSuccessHandler(result => {
          Swal.close();
          if (result.success) {
            Swal.fire('Producto registrado',
              `Producto: ${productoData.nombre}<br>ID: ${result.productoId}`,
              'success');
            cerrarModal('modalRegistroProducto');
            cargarProductos();
            loadDashboard();
          } else {
            Swal.fire('Error', result.error || 'No se pudo registrar', 'error');
          }
        })
        .withFailureHandler(err => {
          Swal.close();
          Swal.fire('Error','Error registrando producto: ' + err.message,'error');
        })
        .registrarProductoPorCodigo(productoData);
    }

    function abrirModalEditarProducto(idProducto) {
      const prod = (productosCache || []).find(p => p.ID_Producto === idProducto);
      if (!prod) {
        Swal.fire('Error', 'No se encontr칩 la informaci칩n del producto', 'error');
        return;
      }

      productoEnEdicion = prod;

      document.getElementById('editIdProducto').value = prod.ID_Producto;
      document.getElementById('editCodigoBarras').value = prod.Codigo_Barras || '';
      document.getElementById('editNombreProducto').value = prod.Nombre_Producto || '';
      document.getElementById('editPrecioProducto').value = prod.Precio || '';
      document.getElementById('editStockMinimo').value = prod.Stock_Minimo || 0;
      document.getElementById('editEstadoProducto').value = prod.Estado || 'Activo';

      document.getElementById('modalEditarProducto').classList.remove('hidden');
    }

    function guardarEdicionProducto() {
      const data = {
        idProducto: document.getElementById('editIdProducto').value,
        codigoBarras: document.getElementById('editCodigoBarras').value.trim(),
        nombre: document.getElementById('editNombreProducto').value.trim(),
        precio: document.getElementById('editPrecioProducto').value,
        stockMinimo: document.getElementById('editStockMinimo').value,
        estado: document.getElementById('editEstadoProducto').value
      };

      if (!data.nombre) {
        Swal.fire('Error', 'El nombre del producto es obligatorio', 'error');
        return;
      }

      Swal.fire({
        title: 'Guardando cambios...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      google.script.run
        .withSuccessHandler(function(res) {
          Swal.close();
          if (res && res.success) {
            Swal.fire('Actualizado', 'Los datos del producto se actualizaron correctamente', 'success');
            cerrarModal('modalEditarProducto');
            cargarProductos();
            cargarProductosParaVenta();
            loadDashboard();
          } else {
            Swal.fire('Error', (res && res.error) || 'No se pudo actualizar el producto', 'error');
          }
        })
        .withFailureHandler(function(err) {
          Swal.close();
          Swal.fire('Error', 'Error al actualizar: ' + err.message, 'error');
        })
        .editarProducto(data);
    }

    function confirmarEliminarProducto(idProducto) {
      Swal.fire({
        title: 'Desactivar producto',
        html: 'Este producto dejar치 de aparecer en las ventas, pero se mantendr치 en el historial.<br><br>쮻eseas continuar?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S칤, desactivar',
        cancelButtonText: 'Cancelar'
      }).then(result => {
        if (!result.isConfirmed) return;

        Swal.fire({
          title: 'Aplicando cambios...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        google.script.run
          .withSuccessHandler(function(res) {
            Swal.close();
            if (res && res.success) {
              Swal.fire('Hecho', 'El producto ha sido desactivado', 'success');
              cargarProductos();
              cargarProductosParaVenta();
              loadDashboard();
            } else {
              Swal.fire('Error', (res && res.error) || 'No se pudo desactivar el producto', 'error');
            }
          })
          .withFailureHandler(function(err) {
            Swal.close();
            Swal.fire('Error', 'Error al desactivar: ' + err.message, 'error');
          })
          .desactivarProducto(idProducto);
      });
    }

    function abrirModalAjustarStock(idProducto) {
      const prod = (productosCache || []).find(p => p.ID_Producto === idProducto);
      if (!prod) {
        Swal.fire('Error', 'No se encontr칩 la informaci칩n del producto', 'error');
        return;
      }

      // Llenar los campos del nuevo modal
      document.getElementById('ajusteIdProducto').value = prod.ID_Producto;
      document.getElementById('ajusteNombreProducto').value = prod.Nombre_Producto || '';
      document.getElementById('ajusteStockActual').value = prod.Stock_Actual || 0;
      // Pre-llenamos el nuevo stock con el valor actual para facilitar
      document.getElementById('ajusteNuevoStock').value = prod.Stock_Actual || 0;  
      document.getElementById('ajusteMotivo').value = ''; // Limpiar motivo

      document.getElementById('modalAjustarStock').classList.remove('hidden');
    }

    function guardarAjusteStock() {
      const ajusteData = {
        idProducto: document.getElementById('ajusteIdProducto').value,
        nuevoStock: document.getElementById('ajusteNuevoStock').value,
        motivo: document.getElementById('ajusteMotivo').value.trim(),
        idUsuario: usuarioActual?.ID_Usuario  
      };

      if (ajusteData.nuevoStock === '' || isNaN(parseInt(ajusteData.nuevoStock)) || parseInt(ajusteData.nuevoStock) < 0) {
        Swal.fire('Error', 'El nuevo stock debe ser un n칰mero v치lido (0 o mayor)', 'error');
        return;
      }

      if (!ajusteData.motivo) {
        Swal.fire('Error', 'Debes ingresar un motivo para el ajuste (ej: conteo, merma)', 'error');
        return;
      }

      Swal.fire({
        title: 'Ajustando stock...',
        text: 'Por favor espere...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      // Llamamos a la funci칩n que YA EXISTE en tu codigo.gs
      google.script.run
        .withSuccessHandler(function(res) {
          Swal.close();
          if (res && res.success) {
            Swal.fire('Stock Ajustado',
              `Stock anterior: ${res.stockAnterior}, Stock nuevo: ${res.stockNuevo}`,
              'success');
            cerrarModal('modalAjustarStock');
            
            // Recargamos todo lo necesario
            cargarProductos(); // Recargar lista de productos
            loadDashboard(); // Recargar dashboard (KPIs de stock)
            cargarProductosParaVenta(); // Recargar productos en POS
          } else {
            Swal.fire('Error', (res && res.error) || 'No se pudo ajustar el stock', 'error');
          }
        })
        .withFailureHandler(function(err) {
          Swal.close();
          Swal.fire('Error', 'Error en la conexi칩n: ' + err.message, 'error');
        })
        .ajustarStockManual(ajusteData);
    }

    function cerrarModal(id) {
      document.getElementById(id).classList.add('hidden');
      detenerEscaneo();
    }

    // Cerrar modal al click fuera
    document.addEventListener('click', e => {
      if (e.target.classList && e.target.classList.contains('modal')) {
        e.target.classList.add('hidden');
        detenerEscaneo();
      }
    });

    // Detectar cuando el usuario elige "俱 Crear nueva categor칤a..."
    const selectCategoria = document.getElementById('categoriaProducto');
    if (selectCategoria) {
      selectCategoria.addEventListener('change', function() {
        if (this.value === '__nueva__') {
          this.value = ''; // reseteamos
          solicitarNuevaCategoria();
        }
      });
    }


    function generarReporteDashboardClick() {
      const filtros = getFilters();

      // Mostrar un loading usando SweetAlert
      Swal.fire({
        title: 'Generando reporte...',
        text: 'Esto puede tomar unos segundos',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run
        .withSuccessHandler(function(resp) {
          Swal.close();

          if (!resp || !resp.success) {
            Swal.fire(
              'Error',
              (resp && resp.error) || 'No se pudo generar el reporte',
              'error'
            );
            return;
          }

          Swal.fire({
            icon: 'success',
            title: 'Reporte generado',
            html: `
              <p><strong>Archivo:</strong> ${resp.nombreArchivo}</p>
              <p><a href="${resp.url}" target="_blank">Abrir PDF</a></p>
            `
          });
        })
        .withFailureHandler(function(err) {
          Swal.close();
          console.error('Error generar reporte:', err);
          Swal.fire(
            'Error',
            'Error generando reporte: ' + err.message,
            'error'
          );
        })
        .generarReporteDashboard(filtros);
    }


    function abrirModalHistorialReportes() {
      document.getElementById('modalHistorialReportes').classList.remove('hidden');
      cargarHistorialReportes();
    }

    function cargarHistorialReportes() {
      const desde   = document.getElementById('fRepDesde')?.value || '';
      const hasta   = document.getElementById('fRepHasta')?.value || '';
      const tipo    = document.getElementById('fRepTipo')?.value || '';
      const usuario = document.getElementById('fRepUsuario')?.value || '';

      google.script.run
        .withSuccessHandler(function(lista) {
          _historialReportes = lista || [];
          pintarHistorialReportes(desde, hasta, tipo, usuario);
        })
        .withFailureHandler(function(err) {
          console.error('Error historial reportes:', err);
          Swal.fire('Error', 'No se pudo cargar el historial de reportes', 'error');
        })
        .getHistorialReportes(); // filtramos en front
    }


    function pintarHistorialReportes(desde, hasta, tipo, usuario) {
      const tbody = document.getElementById('tblHistorialReportesBody');
      tbody.innerHTML = '';

      const fDesde = desde ? new Date(desde) : null;
      const fHasta = hasta ? new Date(hasta) : null;

      _historialReportes
        .filter(function(r) {
          let ok = true;

          if (fDesde || fHasta) {
            const d = new Date(r.Fecha_Generacion);
            if (fDesde && d < fDesde) ok = false;
            if (fHasta) {
              const fh = new Date(fHasta);
              fh.setHours(23, 59, 59, 999);
              if (d > fh) ok = false;
            }
          }

          if (tipo && !String(r.Tipo_Reporte || '').toLowerCase().includes(tipo.toLowerCase())) ok = false;
          if (usuario && !String(r.Generado_Por || '').toLowerCase().includes(usuario.toLowerCase())) ok = false;

          return ok;
        })
        .sort(function(a, b) {
          return new Date(b.Fecha_Generacion) - new Date(a.Fecha_Generacion);
        })
        .forEach(function(r) {
          const tr = document.createElement('tr');

          const rango = (r.Fecha_Desde || '') && (r.Fecha_Hasta || '')
            ? `${formatearFechaCorta(r.Fecha_Desde)} - ${formatearFechaCorta(r.Fecha_Hasta)}`
            : '';

          const url = r.Drive_File_Id
            ? `https://drive.google.com/file/d/${r.Drive_File_Id}/view?usp=drivesdk`
            : '';

          tr.innerHTML = `
            <td>${formatearFechaCorta(r.Fecha_Generacion)}</td>
            <td>${r.Tipo_Reporte || 'Dashboard'}</td>
            <td>${rango}</td>
            <td>${r.Generado_Por || ''}</td>
            <td>
              ${url
                ? `<a href="${url}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-file-pdf"></i> Ver
                  </a>`
                : ''
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
    }

    function abrirModalConfigCorreo() {
      // Pedir configuraci칩n actual al servidor
      google.script.run
        .withSuccessHandler(function(cfg) {
          _configCorreo = cfg || {};

          const emailInput = document.getElementById('cfgEmail');
          const horaInput  = document.getElementById('cfgHora');
          const activoChk  = document.getElementById('cfgActivo');

          emailInput.value = _configCorreo.emailDestino || (usuarioActual && usuarioActual.Email) || '';
          horaInput.value  = _configCorreo.horaEnvio || '09:00';
          activoChk.checked = _configCorreo.activo !== false; // por defecto true

          document.getElementById('modalConfigCorreo').classList.remove('hidden');
        })
        .withFailureHandler(function(err) {
          console.error('Error obteniendo config correo:', err);
          Swal.fire('Error', 'No se pudo cargar la configuraci칩n de correo', 'error');
        })
        .getConfigEnvioReporte();
    }

    function guardarConfigCorreo() {
      const email = document.getElementById('cfgEmail').value.trim();
      const hora  = document.getElementById('cfgHora').value;
      const activo = document.getElementById('cfgActivo').checked;

      if (!email) {
        Swal.fire('Error', 'Ingresa un correo v치lido', 'error');
        return;
      }
      if (!hora) {
        Swal.fire('Error', 'Selecciona una hora diaria', 'error');
        return;
      }

      const config = {
        emailDestino: email,
        horaEnvio: hora,
        activo: activo
      };

      Swal.fire({
        title: 'Guardando configuraci칩n...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      google.script.run
        .withSuccessHandler(function(resp) {
          Swal.close();

          if (!resp || !resp.success) {
            Swal.fire('Error', (resp && resp.error) || 'No se pudo guardar la configuraci칩n', 'error');
            return;
          }

          Swal.fire(
            'Listo',
            'La configuraci칩n de env칤o diario se guard칩 correctamente.',
            'success'
          );
          document.getElementById('modalConfigCorreo').classList.add('hidden');
        })
        .withFailureHandler(function(err) {
          Swal.close();
          console.error('Error guardando config correo:', err);
          Swal.fire('Error', 'No se pudo guardar la configuraci칩n', 'error');
        })
        .guardarConfigEnvioReporte(config);
    }

    //NUEVA FUNCION CIERRE DE CAJA
    function confirmarCierreCaja() {
      if (!usuarioActual || !usuarioActual.ID_Usuario) {
          Swal.fire('Error', 'No se ha identificado al usuario.', 'error');
          return;
      }

      Swal.fire({
        title: 'Generar Cierre de Caja',
        html: `
          <p>Se generar치 un reporte PDF con el resumen de ventas y m칠todos de pago <strong>del d칤a de hoy</strong>.</p>
          <p>Esta acci칩n quedar치 registrada.</p>
          <p>쮻eseas continuar?</p>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S칤, generar cierre',
        cancelButtonText: 'Cancelar'
      }).then(result => {
        if (!result.isConfirmed) return;

        // Mostrar loading
        Swal.fire({
          title: 'Generando Cierre de Caja...',
          text: 'Calculando totales y m칠todos de pago. Esto puede tardar...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // Llamar a la NUEVA funci칩n del servidor
        google.script.run
          .withSuccessHandler(function(resp) {
            Swal.close();
            if (!resp || !resp.success) {
              Swal.fire('Error', (resp && resp.error) || 'No se pudo generar el reporte', 'error');
              return;
            }

            Swal.fire({
              icon: 'success',
              title: 'Cierre de Caja Generado',
              html: `
                <p><strong>Archivo:</strong> ${resp.nombreArchivo}</p>
                <p>El reporte (ID: ${resp.idReporte}) ha sido guardado en Drive y en el historial.</p>
                <p><a href="${resp.url}" target="_blank" class="btn btn-primary">
                   <i class="fas fa-file-pdf"></i> Abrir PDF
                </a></p>
              `
            });
            // Actualizar el historial si est치 abierto
            if (!document.getElementById('modalHistorialReportes').classList.contains('hidden')) {
               cargarHistorialReportes();
            }
          })
          .withFailureHandler(function(err) {
            Swal.close();
            console.error('Error Cierre Caja:', err);
            Swal.fire('Error grave', 'No se pudo generar el cierre: ' + err.message, 'error');
          })
          .generarCierreCajaPDF(usuarioActual.ID_Usuario); // Pasar el ID del usuario
      });
    }


    function toggleReportesDropdown(event) {
        event.stopPropagation();
        const menu = document.getElementById('dropdownReportes');
        if (!menu) return;

        const isShown = menu.classList.contains('show');
        document.querySelectorAll('.dropdown-menu.show')
            .forEach(m => m.classList.remove('show'));

        if (!isShown) {
            menu.classList.add('show');
        }
    }

    // Cerrar el dropdown al hacer click fuera
    document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-menu.show')
            .forEach(m => m.classList.remove('show'));
    });
  </script>
</body>
</html>